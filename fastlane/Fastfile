# Customise this file, documentation can be found here:
# https://github.com/KrauseFx/fastlane/tree/master/docs
# All available actions: https://github.com/KrauseFx/fastlane/blob/master/docs/Actions.md
# can also be listed using the `fastlane actions` command

# If you want to automatically update fastlane if a new version is available:
# update_fastlane

# This is the minimum version number required.
# Update this, if you use features of a newer version
fastlane_version "1.13.0"

default_platform :mac

platform :mac do

  before_all do |lane|
  end

  lane :prebuild do
    cocoapods
  end

  lane :postbuild do
    # nada
  end

  lane :release do

    # prep the local state
    ensure_git_status_clean
    ensure_git_branch(branch: "swift-2")
    git_pull

    # regenerate changelog and make sure it's committed
    sh "cd .. && github_changelog_generator -t $GITHUB_TOKEN"

    # nothing should have changed, we should still be on clean status, if not, commit first
    ensure_git_status_clean

    # ask for the version
    version = prompt(text: 'New Version Tag: ')
    title = prompt(text: 'Release Title: ')
    description = prompt(text: "Release changelog: ",
                         multi_line_end_keyword: "END")

    # TODO: up the CocoaPod version spec, commit and push and pod trunk push before you make the release

    # create a new release on GitHub
    release = set_github_release(
      repository_name: "czechboy0/XcodeServerSDK",
      api_token: ENV["GITHUB_TOKEN"],
      name: [version, title].join(" - "),
      tag_name: version,
      description: description,
      is_draft: false,
      is_prerelease: false
    )

    # notify us on slack
    slack(
      message: "Successfully released [XcodeServerSDK #{version}](#{release['html_url']}) :rocket:",
      payload: {
        "New" => release['body']
      }
    )
  end

  #TODO: create a lane for releasing a new podspec

  after_all do |lane|    

    if lane == :postbuild
      slack(
        message: "XcodeServerSDK: Build finished"
      )
    end
    if lane == :release
      slack(
        message: "XcodeServerSDK: New Version Released: https://github.com/czechboy0/XcodeServerSDK/releases"
        )
    end
  end
 
  error do |lane, exception|
    if lane == :postbuild
      slack(
        message: "XcodeServerSDK: Seems like we have a failing build: #{exception.message}",
        success: false
      )
    end
  end

end

